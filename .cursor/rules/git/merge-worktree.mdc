# Merge Worktree

## When to use

When merging changes between the main branch and an agent worktree branch.

## Agent worktree layout

| Worktree | Directory | Branch prefix |
|---|---|---|
| main | `~/projects/APAS-VERUS` | `main` |
| agent1 | `~/projects/APAS-VERUS-agent1` | `agent1/` |
| agent2 | `~/projects/APAS-VERUS-agent2` | `agent2/` |

## Main — merging an agent branch (one at a time)

Merge agent branches sequentially, never simultaneously. Complete the full verify cycle
for one agent before starting the next.

```bash
# 1. Merge the agent branch into main (replace BRANCH with e.g. agent1/verusify-chap37)
git merge BRANCH

# 2. If conflicts: fix them, then
git add -A && GIT_EDITOR=true git merge --continue

# 3. Verify: compilation
cargo check --lib

# 4. Verify: RTTs
cargo nextest run --no-fail-fast

# 5. Verify: validate (full)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors

# 6. Verify: validate (dev_only)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors --cfg 'feature="dev_only"'

# 7. Verify: compile_ptt (build .rlib + .vir for proof-time tests)
~/projects/verus/source/target-verus/release/verus \
  --compile --crate-type=lib --crate-name apas_verus src/lib.rs \
  -o target/verus/libapas_verus.rlib \
  --export /home/milnes/projects/APAS-VERUS/target/verus/apas_verus.vir

# 8. Verify: PTTs
cd rust_verify_test && cargo nextest run --no-fail-fast && cd ..

# 9. Push
git push
```

## Agent — catching up after main merges

Each agent rebases onto the updated main after it has been pushed.

```bash
# 1. Fetch the merged main
git fetch origin

# 2. Rebase the agent branch onto main
git rebase origin/main

# 3. If conflicts: fix them, then
git add -A && GIT_EDITOR=true git rebase --continue

# 4. Verify: compilation
cargo check --lib

# 5. Verify: RTTs
cargo nextest run --no-fail-fast

# 6. Verify: validate (full)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors

# 7. Verify: validate (dev_only)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors --cfg 'feature="dev_only"'

# 8. Verify: compile_ptt
~/projects/verus/source/target-verus/release/verus \
  --compile --crate-type=lib --crate-name apas_verus src/lib.rs \
  -o target/verus/libapas_verus.rlib \
  --export /home/milnes/projects/APAS-VERUS/target/verus/apas_verus.vir

# 9. Verify: PTTs
cd rust_verify_test && cargo nextest run --no-fail-fast && cd ..

# 10. Force-push rebased branch
git push origin BRANCH --force
```

## Notes

- Merge one agent at a time. Never merge agent1 and agent2 into main simultaneously.
- After main merges agent1, push main, then BOTH agent1 and agent2 should rebase.
- Each agent works only in its own worktree. Never cd into another agent's directory.
- Use `GIT_EDITOR=true` for merge/rebase --continue to avoid the "dumb terminal" error.
- Always run full verification after merge/rebase on ALL sides — even if the merge was clean.
- Fix conflicts before verifying.
