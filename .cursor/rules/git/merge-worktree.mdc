# Merge Worktree

## When to use

When merging changes between the main branch and a worktree branch (e.g., `review/prose`).

## This AI (main worktree) — merging a worktree branch into main

```bash
# 1. Merge the worktree branch into main
git merge review/prose

# 2. If conflicts: fix them, then
git add -A && git merge --continue

# 3. Verify: compilation
cargo check --lib

# 4. Verify: RTTs
cargo nextest run --no-fail-fast

# 5. Verify: validate (full)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors

# 6. Verify: validate (dev_only)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors --cfg 'feature="dev_only"'

# 7. Verify: compile_ptt (build .rlib + .vir for proof-time tests)
~/projects/verus/source/target-verus/release/verus \
  --compile --crate-type=lib --crate-name apas_verus src/lib.rs \
  -o target/verus/libapas_verus.rlib \
  --export /home/milnes/projects/APAS-VERUS/target/verus/apas_verus.vir

# 8. Verify: PTTs
cd rust_verify_test && cargo nextest run --no-fail-fast && cd ..

# 9. Push
git push
```

## The other AI (worktree) — catching up after merge

```bash
# 1. Fetch the merged main
git fetch origin

# 2. Rebase the worktree branch onto main
git rebase origin/main

# 3. Verify: compilation
cargo check --lib

# 4. Verify: RTTs
cargo nextest run --no-fail-fast

# 5. Verify: validate (full)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors

# 6. Verify: validate (dev_only)
~/projects/verus/source/target-verus/release/verus --crate-type=lib src/lib.rs --multiple-errors 20 --expand-errors --cfg 'feature="dev_only"'

# 7. Verify: compile_ptt
~/projects/verus/source/target-verus/release/verus \
  --compile --crate-type=lib --crate-name apas_verus src/lib.rs \
  -o target/verus/libapas_verus.rlib \
  --export /home/milnes/projects/APAS-VERUS/target/verus/apas_verus.vir

# 8. Verify: PTTs
cd rust_verify_test && cargo nextest run --no-fail-fast && cd ..

# 9. Force-push rebased branch
git push origin review/prose --force
```

## Notes

- No `git fetch` needed on the main side if both branches are local and up to date.
- The worktree branch DOES need `git fetch origin` because it needs to see the merged main that was pushed.
- Always run full verification (cargo check, RTTs, PTT full, PTT dev_only) after merge on BOTH sides.
- Fix conflicts before verifying — do not skip verification even if merge was clean.
