<style>
body { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 1em !important; }
.markdown-body { max-width: 100% !important; width: 100% !important; }
.container, .container-lg, .container-xl, main, article { max-width: 100% !important; width: 100% !important; }
table { width: 100% !important; table-layout: fixed; }
</style>

# Chapter 36 -- Quicksort: Review Against Prose

**Date:** 2026-02-27
**Reviewer:** Claude-Opus-4.6

## Phase 1: Inventory

Generated by `veracity-review-module-fn-impls -d src/Chap36/`.

| # | Chap | File | Function | V! | Location | Spec | SpecStr |
|---|:----:|------|----------|:--:|----------|:----:|:-------:|
| 1 | 36 | QuickSortStEph.rs | `spec_leq` | Y | ML | Spec | strong |
| 2 | 36 | QuickSortStEph.rs | `spec_median_of_three` | Y | ML | Spec | strong |
| 3 | 36 | QuickSortStEph.rs | `lemma_total_ordering` | Y | ML | HasSpec | strong |
| 4 | 36 | QuickSortStEph.rs | `quick_sort_first` | Y | Tr+IT | HasSpec | strong |
| 5 | 36 | QuickSortStEph.rs | `quick_sort_median3` | Y | Tr+IT | HasSpec | strong |
| 6 | 36 | QuickSortStEph.rs | `quick_sort_random` | Y | Tr+IT | HasSpec | strong |
| 7 | 36 | QuickSortStEph.rs | `sort_vec` | Y | ML | HasSpec | strong |
| 8 | 36 | QuickSortStEph.rs | `sort_vec_with_idx` | Y | ML | HasSpec | strong |
| 9 | 36 | QuickSortStEph.rs | `sort_vec_random` | Y | ML | HasSpec | strong |
| 10 | 36 | QuickSortStEph.rs | `sort_vec_median3` | Y | ML | HasSpec | strong |
| 11 | 36 | QuickSortStEph.rs | `median_of_three` | Y | ML | HasSpec | strong |
| 12 | 36 | QuickSortStEph.rs | `median3_pivot_idx` | Y | ML | HasSpec | strong |
| 13 | 36 | QuickSortMtEph.rs | `spec_leq` | Y | ML | Spec | strong |
| 14 | 36 | QuickSortMtEph.rs | `spec_median_of_three` | Y | ML | Spec | strong |
| 15 | 36 | QuickSortMtEph.rs | `lemma_total_ordering` | Y | ML | HasSpec | strong |
| 16 | 36 | QuickSortMtEph.rs | `quick_sort_first` | Y | Tr+IT | HasSpec | strong |
| 17 | 36 | QuickSortMtEph.rs | `quick_sort_median3` | Y | Tr+IT | HasSpec | strong |
| 18 | 36 | QuickSortMtEph.rs | `quick_sort_random` | Y | Tr+IT | HasSpec | strong |
| 19 | 36 | QuickSortMtEph.rs | `sort_vec` | Y | ML | HasSpec | strong |
| 20 | 36 | QuickSortMtEph.rs | `sort_vec_with_idx` | Y | ML | HasSpec | strong |
| 21 | 36 | QuickSortMtEph.rs | `sort_vec_random` | Y | ML | HasSpec | strong |
| 22 | 36 | QuickSortMtEph.rs | `sort_vec_median3` | Y | ML | HasSpec | strong |
| 23 | 36 | QuickSortMtEph.rs | `median_of_three` | Y | ML | HasSpec | strong |
| 24 | 36 | QuickSortMtEph.rs | `median3_pivot_idx` | Y | ML | HasSpec | strong |
| 25 | 36 | QuickSortMtEphSlice.rs | `pivot_mt_first` | Y | Tr+IT | HasSpec | partial |
| 26 | 36 | QuickSortMtEphSlice.rs | `pivot_mt_median3` | Y | Tr+IT | HasSpec | partial |
| 27 | 36 | QuickSortMtEphSlice.rs | `pivot_mt_random` | Y | Tr+IT | HasSpec | partial |
| 28 | 36 | QuickSortMtEphSlice.rs | `quick_sort_mt_first` | Y | Tr+IT | NoSpec | none |
| 29 | 36 | QuickSortMtEphSlice.rs | `quick_sort_mt_median3` | Y | Tr+IT | NoSpec | none |
| 30 | 36 | QuickSortMtEphSlice.rs | `quick_sort_mt_random` | Y | Tr+IT | NoSpec | none |

## Phase 2: Prose Inventory

Source: `prompts/Chap36.txt` -- Chapter 36, "Quicksort" from APAS.

### Definitions

| # | Definition | Prose Reference |
|---|-----------|-----------------|
| 1 | Pivot tree | Recursive decomposition tree induced by pivot choices; depth determines span. |
| 2 | Balanced vs. lopsided tree | Sorted input + first-element pivot yields depth n; random pivot yields depth Theta(lg n) expected. |

### Algorithms

| # | Algorithm | Prose Reference |
|---|-----------|-----------------|
| 1 | **Algorithm 36.1** -- Generic Quicksort | Partition into `a1 = <x \| x < p>`, `a2 = <x \| x = p>`, `a3 = <x \| x > p>`; recursively sort `a1` and `a3` in parallel; concatenate `s1 ++ a2 ++ s3`. |

### Pivot Strategies

| # | Strategy | Description | Work | Span |
|---|----------|-------------|------|------|
| 1 | First element | Always pick `a[0]` | Theta(n^2) worst | Theta(n^2) St / Theta(n) Mt worst |
| 2 | Median of three | Median of first, middle, last | Theta(n lg n) sorted; Theta(n^2) worst | Same as first-element worst |
| 3 | Random element | Uniformly random | Theta(n lg n) expected | Theta(lg^2 n) expected |

### Cost Specifications

| # | Item | Work | Span |
|---|------|------|------|
| 1 | Algorithm 36.1 (random pivot) | Theta(n lg n) expected | Theta(lg^2 n) expected |
| 2 | Algorithm 36.1 (first element, sorted) | Theta(n^2) | Theta(n) Mt / Theta(n^2) St |
| 3 | Partition step (prose: parallel filter) | Theta(n) work | Theta(lg n) span |
| 4 | Partition step (implementation: sequential DNF) | Theta(n) work | Theta(n) span |

### Theorems / Properties

| # | Property | Description |
|---|----------|-------------|
| 1 | Correctness | Output is a permutation of input and is sorted. |
| 2 | Random pivot expected work | Theta(n lg n) -- probabilistic argument. |
| 3 | Random pivot expected depth | Theta(lg n) -- recursion tree depth w.h.p. |

### Exercises

None specified in the prompt for Chapter 36.

## Phase 3: Algorithmic Analysis

### 3a. Function Structure

The prose defines **one algorithm** (Algorithm 36.1) with **three pivot strategies**. The code factors this as:

| # | Chap | File | Function | Role |
|---|:----:|------|----------|------|
| 1 | 36 | QuickSortStEph.rs | `sort_vec_with_idx` | Core algorithm: partition, recurse, concat. |
| 2 | 36 | QuickSortStEph.rs | `sort_vec` | Base-case handler + first-element entry. |
| 3 | 36 | QuickSortStEph.rs | `sort_vec_random` | Random pivot wrapper. |
| 4 | 36 | QuickSortStEph.rs | `sort_vec_median3` | Median-of-3 pivot wrapper. |
| 5 | 36 | QuickSortStEph.rs | `median_of_three` | Exec: compute median of three values. |
| 6 | 36 | QuickSortStEph.rs | `median3_pivot_idx` | Exec: index of median among a[0], a[n/2], a[n-1]. |
| 7 | 36 | QuickSortStEph.rs | `spec_median_of_three` | Spec: median of three values. |
| 8 | 36 | QuickSortStEph.rs | `spec_leq` | Spec: leq closure for vstd sort_by. |
| 9 | 36 | QuickSortStEph.rs | `lemma_total_ordering` | Proof: bridge TotalOrder to vstd total_ordering. |

Each function earns its place: three pivot strategies require separate entry points (3 trait methods + 3 wrappers), median-of-3 needs its own support (3 functions), and the proof infrastructure needs `spec_leq` + `lemma_total_ordering`. MtEph duplicates the same structure with `ParaPair!` for parallel recursion.

### 3b. Critical Bug: Recursive Pivot Strategy Not Preserved

**`sort_vec_with_idx` always recurses through `sort_vec`, which always uses pivot index 0.**

Call chain for `quick_sort_random`:
```
quick_sort_random -> sort_vec_random -> sort_vec_with_idx(a, random_idx)  [top-level only]
  sort_vec_with_idx -> sort_vec(&left), sort_vec(&right)                  [recurse]
    sort_vec -> sort_vec_with_idx(a, 0)                                   [ALWAYS first-element!]
```

The random and median-of-3 pivot strategies are applied ONCE at the top level. All recursive calls revert to first-element pivot. This means:
- `quick_sort_random` does NOT have Theta(n lg n) expected work -- it has the same Theta(n^2) worst case as first-element on pathological sub-problems.
- `quick_sort_median3` provides no benefit beyond the first partition level.

**This does NOT affect the proof.** The postcondition `sorted@ =~= a.seq@.sort_by(spec_leq())` is still satisfied. But the runtime behavior does not match the textbook algorithm, which applies the same pivot strategy at every recursive level.

Both QuickSortStEph.rs and QuickSortMtEph.rs have this bug.

### 3c. Cost Annotations

| # | Chap | File | Function | APAS Cost | Actual Cost | Match? |
|---|:----:|------|----------|-----------|-------------|:------:|
| 1 | 36 | QuickSortStEph.rs | `quick_sort_first` | W Theta(n^2) worst | W Theta(n^2) worst | Yes |
| 2 | 36 | QuickSortStEph.rs | `quick_sort_median3` | W Theta(n lg n) sorted | **W Theta(n^2) worst** (recursive pivot bug) | **No** |
| 3 | 36 | QuickSortStEph.rs | `quick_sort_random` | W Theta(n lg n) expected | **W Theta(n^2) worst** (recursive pivot bug) | **No** |
| 4 | 36 | QuickSortMtEph.rs | `quick_sort_first` | W Theta(n^2), S Theta(n) | W Theta(n^2), S Theta(n) | Yes |
| 5 | 36 | QuickSortMtEph.rs | `quick_sort_median3` | S Theta(lg^2 n) exp | **S Theta(n)** (seq partition + pivot bug) | **No** |
| 6 | 36 | QuickSortMtEph.rs | `quick_sort_random` | S Theta(lg^2 n) exp | **S Theta(n)** (seq partition + pivot bug) | **No** |

### 3d. Implementation Fidelity

| # | Chap | File | Faithful? | Notes |
|---|:----:|------|:---------:|-------|
| 1 | 36 | QuickSortStEph.rs | **Partial** | Correct partition-sort-concat structure. Recursive pivot bug means only `quick_sort_first` truly matches the prose. |
| 2 | 36 | QuickSortMtEph.rs | **Partial** | Same as StEph + `ParaPair!` for parallel recursion. Same recursive pivot bug. |
| 3 | 36 | QuickSortMtEphSlice.rs | **Dead** | Commented out in lib.rs. Missing `with_exclusive`. Nested fns (Verus prohibition). `quick_sort_mt_random` is actually median-of-3 (rand disabled). |

### 3e. Spec Fidelity

| # | Chap | File | Postcondition | Adequate? |
|---|:----:|------|---------------|:---------:|
| 1 | 36 | QuickSortStEph.rs | `sorted@ =~= a.seq@.sort_by(spec_leq())` | **Strong** |
| 2 | 36 | QuickSortStEph.rs | `median == spec_median_of_three(a, b, c)` | **Strong** |
| 3 | 36 | QuickSortStEph.rs | `a.seq@[idx] == spec_median_of_three(...)` | **Strong** |
| 4 | 36 | QuickSortMtEph.rs | Same as StEph (all three postconditions) | **Strong** |
| 5 | 36 | QuickSortMtEphSlice.rs | No ensures on sort fns | **None** |

### 3f. Standalone

Both StEph and MtEph define `spec_leq`, `spec_median_of_three`, and `lemma_total_ordering` locally. No cross-chapter or cross-file imports. **Standalone: satisfied.**

(The previous review incorrectly claimed Chap35 imports existed. Verified false -- both files are self-contained.)

## Phase 4: Parallelism Review

### Classify Each Mt Function

| # | Chap | File | Function | Classification | Mechanism |
|---|:----:|------|----------|:--------------:|-----------|
| 1 | 36 | QuickSortMtEph.rs | `sort_vec_with_idx` | **Parallel** | `ParaPair!(f1, f2)` |
| 2 | 36 | QuickSortMtEph.rs | `quick_sort_first` | **Parallel** | Delegates to `sort_vec` |
| 3 | 36 | QuickSortMtEph.rs | `quick_sort_median3` | **Parallel** | Via `sort_vec_median3` |
| 4 | 36 | QuickSortMtEph.rs | `quick_sort_random` | **Parallel** | Via `sort_vec_random` |
| 5 | 36 | QuickSortMtEphSlice.rs | `quick_sort_mt_*` | **Parallel** | `thread::scope` (dead code) |

### Span Audit

| # | Chap | File | Function | APAS Span | Actual Span | Match? |
|---|:----:|------|----------|-----------|-------------|:------:|
| 1 | 36 | QuickSortMtEph.rs | `quick_sort_first` | Theta(n) worst | Theta(n) | Yes |
| 2 | 36 | QuickSortMtEph.rs | `quick_sort_median3` | Theta(lg^2 n) exp | **Theta(n)** | **No** |
| 3 | 36 | QuickSortMtEph.rs | `quick_sort_random` | Theta(lg^2 n) exp | **Theta(n)** | **No** |

Span mismatch has two causes: (a) sequential DNF partition (Theta(n) per level), (b) recursive pivot bug (pivot strategy not preserved).

## Phase 5: Runtime Test Review

| # | Chap | File | Tests | Coverage |
|---|:----:|------|:-----:|----------|
| 1 | 36 | TestQuickSortStEph.rs | 2 | All 3 variants, edge cases |
| 2 | 36 | TestQuickSortMtEph.rs | 4 | All 3 variants, edge, large, concurrent |
| 3 | 36 | TestQuickSortMtEphSlice.rs | 16 | Exercises dead module |
| 4 | 36 | BenchQuickSort.rs | 1 | St vs Mt x 3 pivots at n=100/500/2000 |

Test quality is good for StEph/MtEph. MtEphSlice tests exercise unverified dead code.

## Phase 6: PTT Review

No PTT files for Chap36. Not needed -- partition invariant verifies cleanly.

## Phase 7: Gap Analysis

### Prose items with no (correct) implementation

| # | Prose Item | Status | Notes |
|---|-----------|--------|-------|
| 1 | Random pivot at every level | **Broken** | Only applied at top level due to recursive pivot bug. |
| 2 | Median-of-3 at every level | **Broken** | Same recursive pivot bug. |
| 3 | Parallel filter partition | **Not implemented** | All variants use sequential DNF. |
| 4 | Expected cost analysis | **Not formalized** | No spec-level cost model. |

### Code with no prose counterpart

| # | Chap | File | Item | Purpose |
|---|:----:|------|------|---------|
| 1 | 36 | QuickSortMtEphSlice.rs | Entire module | Slice-based variant -- dead code. |
| 2 | 36 | QuickSortStEph.rs | Base case n=1 | Prose only specifies n=0. Correct extension. |

## Phase 8: TOC Review

| # | Chap | File | Has TOC? | Correct? | Sections |
|---|:----:|------|:--------:|:--------:|----------|
| 1 | 36 | QuickSortStEph.rs | Yes | Yes | 1,2,3,6,7,8,9 |
| 2 | 36 | QuickSortMtEph.rs | Yes | Yes | 1,2,3,6,7,8,9 |
| 3 | 36 | QuickSortMtEphSlice.rs | No | N/A | Dead module |

## Proof Holes Summary

```
veracity-review-proof-holes -d src/Chap36/

Modules: 3 clean, 0 holed, 3 total
Holes Found: 0 total
```

All three modules are clean.

## Style Warnings

```
veracity-review-verus-style -c ~/projects/APAS-VERUS-agent1 src/Chap36/
Summary: 47 passed, 3 warnings in 1 file (checked 3 files)
```

All 3 warnings are in QuickSortMtEphSlice.rs (dead code): trait fns `quick_sort_mt_first`, `quick_sort_mt_median3`, `quick_sort_mt_random` lack requires/ensures.

## Spec Strength Summary

| # | Classification | Count |
|---|:--------------:|:-----:|
| 1 | strong | 24 |
| 2 | partial | 3 |
| 3 | weak | 0 |
| 4 | none | 3 |

## Proposed Fixes Table

| # | Severity | Chap | File | Issue | Fix |
|---|:--------:|:----:|------|-------|-----|
| 1 | **Critical** | 36 | QuickSortStEph.rs | Recursive pivot bug: `sort_vec_with_idx` recurses via `sort_vec` which always uses pivot 0. Random/median3 strategies only apply at top level. | Fold base cases into `sort_vec_with_idx`, make `sort_vec_random`/`sort_vec_median3` call it recursively with their own pivot selection. |
| 2 | **Critical** | 36 | QuickSortMtEph.rs | Same recursive pivot bug as StEph. | Same fix as StEph, preserving `ParaPair!` for parallel recursion. |
| 3 | **Medium** | 36 | QuickSortMtEphSlice.rs | Dead module: commented out in lib.rs, uses missing `with_exclusive`, nested fns (Verus prohibition), `random` variant is median-of-3 (rand disabled). | Delete file and its 16 tests + Cargo.toml entry. |
| 4 | **Low** | 36 | QuickSortMtEph.rs | Cost comments claim Theta(lg^2 n) span for median3/random. Actual is Theta(n) due to sequential partition. | Update comments to reflect sequential partition span. |
