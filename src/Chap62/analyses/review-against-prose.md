<style>
body { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 1em !important; }
.markdown-body { max-width: 100% !important; width: 100% !important; }
.container, .container-lg, .container-xl, main, article { max-width: 100% !important; width: 100% !important; }
table { width: 100% !important; table-layout: fixed; }
</style>

# Chapter 62: Star Contraction — Review Against Prose

**Date:** 2026-02-13 (updated 2026-02-18: verusification — traits inside verus!, impls cfg-gated)
**Reviewer:** Claude-Opus-4.6
**Verus coverage:** Partial — trait definitions inside `verus!`, implementations `#[cfg(not(verus_keep_ghost))]`
**lib.rs gate:** No longer behind `#[cfg(not(verus_keep_ghost))]` — Verus sees the trait declarations

## Phase 1: Inventory (tool-generated)

Generated by `veracity-review-module-fn-impls -d src/Chap62`.

| # | Dir | Module | Tr | IT | IBI | ML | V! | -V! | Unk | Hole | NoSpec | SpecStr |
|---|-----|--------|:--:|:--:|:---:|:--:|:--:|:---:|:---:|:----:|:------:|:-------:|
| 1 | Chap62 | StarContractionMtEph | 2 | 0 | 0 | 4 | 2 | 2 | 0 | 0 | 4 | none |
| 2 | Chap62 | StarContractionStEph | 2 | 0 | 0 | 3 | 2 | 1 | 0 | 0 | 3 | none |
| 3 | Chap62 | StarPartitionMtEph | 1 | 0 | 0 | 1 | 1 | 0 | 0 | 0 | 1 | none |
| 4 | Chap62 | StarPartitionStEph | 1 | 0 | 0 | 1 | 1 | 0 | 0 | 0 | 1 | none |

9 exec functions total. 6 trait method declarations inside `verus!` (type-checked by Verus), 3 implementation functions outside `verus!` with `#[cfg(not(verus_keep_ghost))]`. All 9 have no functional spec (no `requires`/`ensures`). The chapter is no longer gated behind `#[cfg(not(verus_keep_ghost))]` in `lib.rs`.

**Fully inside verus!**: StarPartitionMtEph (V!=1, -V!=0), StarPartitionStEph (V!=1, -V!=0) — all trait method declarations are inside `verus!` with no remaining outside functions.

## Phase 2: Prose Inventory

Source: `prompts/Chap62.txt` (Chapter 62: Star Contraction)

### Definitions

| # | Definition | Description |
|---|-----------|-------------|
| 1 | Definition 62.1 — Star Partition | A partition of a graph where each block is a vertex-induced subgraph w.r.t. a star graph. |
| 2 | Definition 62.2 — Isolated Vertices | A vertex with no neighbors. |
| 3 | Definition 62.4 — Star Contraction | Graph contraction using star partitions. |

### Algorithms

| # | Algorithm | Description |
|---|----------|-------------|
| 1 | Sequential Star Partition | Greedy: pick vertex, make center, attach neighbors as satellites, repeat. |
| 2 | Algorithm 62.3 — Parallel Star Partition (`starPartition`) | Randomized coin flips: heads → center, tails → satellite of a head-neighbor (or self-center). Uses Seq.inject. |
| 3 | Algorithm 62.5 — Star Contraction (`starContract`) | Higher-order recursive contraction: partition → quotient graph → recur → expand. |

### Cost Specs

| # | Item | Work | Span |
|---|------|------|------|
| 1 | Theorem 62.1 — `starPartition` | O(n + m) | O(lg n) |
| 2 | Theorem 62.3 — `starContract` | O((n + m) lg n) | O(lg² n) |

### Theorems/Properties

| # | Item | Description |
|---|------|-------------|
| 1 | Lemma 62.2 — Number of Satellites | For a graph with n• non-isolated vertices, expected satellites ≥ n•/4. |
| 2 | Exercise 62.1 | Prove Theorem 62.1 (text proof — not code). |

### Exercises/Problems

| # | Item | Type | Implemented? |
|---|------|------|:------------:|
| 1 | Exercise 62.1 | Text proof of Theorem 62.1 | No (text proof, not code) |

## Phase 3: Algorithmic Analysis

### 3a. Cost Annotations

All exec functions now have paired APAS / Claude-Opus-4.6 cost comments.

| # | Function | File | APAS Cost | Claude-Opus-4.6 Cost | Agreement |
|---|----------|------|-----------|---------------------|:---------:|
| 1 | `sequential_star_partition` | StarPartitionStEph.rs | Work Θ(n+m), Span Θ(n+m) | Work Θ(n+m), Span Θ(n+m) | ✅ |
| 2 | `parallel_star_partition` | StarPartitionMtEph.rs | Work O(n+m), Span O(lg n) | Work O(n+m), Span O(n+m) | ❌ |
| 3 | `star_contract` | StarContractionStEph.rs | Work O((n+m) lg n), Span O((n+m) lg n) | Work O((n+m) lg n), Span O((n+m) lg n) | ✅ |
| 4 | `build_quotient_graph` | StarContractionStEph.rs | N/A (helper) | Work O(m), Span O(m) | — |
| 5 | `contract_to_vertices` | StarContractionStEph.rs | Work O((n+m) lg n), Span O((n+m) lg n) | Work O((n+m) lg n), Span O((n+m) lg n) | ✅ |
| 6 | `star_contract_mt` | StarContractionMtEph.rs | Work O((n+m) lg n), Span O(lg² n) | Work O((n+m) lg n), Span O((n+m) lg n) | ❌ |
| 7 | `build_quotient_graph_parallel` | StarContractionMtEph.rs | N/A (helper) | Work O(m), Span O(lg m) | — |
| 8 | `route_edges_parallel` | StarContractionMtEph.rs | N/A (helper) | Work O(k), Span O(lg k) | — |
| 9 | `contract_to_vertices_mt` | StarContractionMtEph.rs | Work O((n+m) lg n), Span O(lg² n) | Work O((n+m) lg n), Span O((n+m) lg n) | ❌ |

### 3b. Implementation Fidelity

| # | Function | Prose Reference | Fidelity | Notes |
|---|----------|----------------|:--------:|-------|
| 1 | `sequential_star_partition` | Sequential construction (§1) | **Good** | Follows greedy approach: pick vertex, add neighbors as satellites, remove. Returns `(centers, HashMap)` instead of `(Vc, P)` as in prose, but semantically equivalent. |
| 2 | `parallel_star_partition` | Algorithm 62.3 | **Partial** | Follows the algorithm structure (coin flips → TH edges → inject → extract centers), but all phases are implemented with sequential `for` loops despite being in an Mt module. The Seq.inject is a sequential `p_vec[idx] = vertex` loop. |
| 3 | `star_contract` | Algorithm 62.5 | **Good** | Matches prose: base case on `|E| = 0`, partition → quotient → recur → expand. |
| 4 | `build_quotient_graph` | Line 7 of Algorithm 62.5 | **Good** | Routes edges through partition map, removes self-loops. Edge normalization (ordering) is an implementation detail not in prose. |
| 5 | `star_contract_mt` | Algorithm 62.5 (parallel) | **Partial** | Structure matches prose but calls sequential `parallel_star_partition`, so the partition phase is not actually parallel. Quotient build is parallel via `route_edges_parallel`. |
| 6 | `route_edges_parallel` | Line 7 of Algorithm 62.5 | **Good** | Binary divide-and-conquer with `ParaPair!` — genuine parallelism. |

### 3c. Spec Fidelity

All 9 functions have **no functional specification** (no `requires`/`ensures`). Trait definitions are now inside `verus!` blocks, so Verus type-checks the trait method signatures. However, the trait methods declare no `requires` or `ensures` clauses — the signatures are purely structural (parameter types and return types) with no functional contracts.

**Gap:** The prose specifies:
- `starPartition` returns `(Vc, P)` where `Vc = V \ domain(Ps)` and `P = Ps ∪ Pc`
- The partition map covers all vertices
- Centers map to themselves
- Every satellite maps to exactly one center

None of these are formally specified. Adding `ensures` clauses to the trait methods is now possible since the traits are inside `verus!`.

## Phase 4: Parallelism Review

### 4a. Mt Function Classification

| # | Function | Classification | Mechanism |
|---|----------|:-------------:|-----------|
| 1 | `parallel_star_partition` | **Sequential** | All 4 phases use `for` loops. No spawning. |
| 2 | `star_contract_mt` | **Sequential** | Calls sequential `parallel_star_partition`. Quotient build is parallel but partition dominates. |
| 3 | `build_quotient_graph_parallel` | **Parallel** | Delegates to `route_edges_parallel`. |
| 4 | `route_edges_parallel` | **Parallel** | Binary fork-join via `ParaPair!` macro. |
| 5 | `contract_to_vertices_mt` | **Delegating** | Calls `star_contract_mt`. |

### 4b. Span Audit

| # | Function | APAS Span | Actual Span | Match? | Notes |
|---|----------|-----------|-------------|:------:|-------|
| 1 | `parallel_star_partition` | O(lg n) | O(n + m) | ❌ | Sequential loops → Span = Work. |
| 2 | `star_contract_mt` | O(lg² n) | O((n+m) lg n) | ❌ | Partition is sequential → contraction span dominated by partition. |
| 3 | `build_quotient_graph_parallel` | — | O(lg m) | — | Genuinely parallel. |
| 4 | `route_edges_parallel` | — | O(lg k) | — | Genuinely parallel. |
| 5 | `contract_to_vertices_mt` | O(lg² n) | O((n+m) lg n) | ❌ | Same as `star_contract_mt`. |

### 4c. Parallelism Gap Table

| # | Function | APAS Span | Actual Span | Parallel? | Notes |
|---|----------|-----------|-------------|:---------:|-------|
| 1 | `parallel_star_partition` | O(lg n) | O(n+m) | No | All 4 phases (coin flip, TH, inject, centers) are sequential `for` loops. |
| 2 | `star_contract_mt` | O(lg² n) | O((n+m) lg n) | Partial | Quotient build is parallel, but partition phase dominates. |
| 3 | `build_quotient_graph_parallel` | — | O(lg m) | Yes | Fork-join via `ParaPair!`. |
| 4 | `route_edges_parallel` | — | O(lg k) | Yes | Fork-join via `ParaPair!`. |
| 5 | `contract_to_vertices_mt` | O(lg² n) | O((n+m) lg n) | No | Delegates to sequential partition. |

**Key finding:** `parallel_star_partition` is the bottleneck. It needs parallel implementations of:
1. Coin flipping (parallel map over vertices)
2. TH edge filtering (parallel filter over edges)
3. Seq.inject (parallel scatter)
4. Center extraction (parallel filter)

Without parallel partition, the Mt contraction cannot achieve its O(lg² n) span.

## Phase 5: Runtime Test Review

### 5a. Coverage Check

**No runtime test files exist for Chap62.** No `tests/` files match `Chap62`, `star`, or `62`.

| # | Source Module | RTT File | Status |
|---|-------------|----------|--------|
| 1 | StarPartitionStEph | — | **Missing** |
| 2 | StarPartitionMtEph | — | **Missing** |
| 3 | StarContractionStEph | — | **Missing** |
| 4 | StarContractionMtEph | — | **Missing** |

### 5b. Test Quality

N/A — no tests exist.

### 5c. Missing Tests (Recommended)

| # | Priority | Test | Rationale |
|---|:--------:|------|-----------|
| 1 | High | `TestStarPartitionStEph` | Validate sequential partition covers all vertices, centers map to self, partition map is complete. |
| 2 | High | `TestStarPartitionMtEph` | Validate parallel partition produces valid partition with randomized coins. |
| 3 | High | `TestStarContractionStEph` | Validate contraction terminates, base case reached, graph contracts to isolated vertices. |
| 4 | Medium | `TestStarContractionMtEph` | Validate parallel contraction matches sequential result. |

## Phase 6: Proof-Time Test (PTT) Review

Chapter 62 has **no verified loops, no iterators, and no `requires`/`ensures` clauses**. Trait definitions are inside `verus!` blocks and are type-checked, but since they declare no functional specs, there is nothing to test at proof time. **No PTTs are needed** until functional specs are added to the trait methods.

## Phase 7: Gap Analysis

### Prose Items with No Implementation

| # | Prose Item | Status |
|---|-----------|--------|
| 1 | Definition 62.1 — Star Partition (type) | No formal type representing a star partition. `(SetStEph<V>, HashMap<V, V>)` is used informally. |
| 2 | Definition 62.2 — Isolated Vertices | No `is_isolated` predicate. |
| 3 | Lemma 62.2 — Number of Satellites | Not implemented (probabilistic; text proof). |
| 4 | Exercise 62.1 — Prove Theorem 62.1 | Not implemented (text proof). |
| 5 | Theorem 62.1 — Cost of Star Partition | Cost stated in comments but not formally proved. |
| 6 | Theorem 62.3 — Work/Span of Star Contraction | Cost stated in comments but not formally proved. |
| 7 | `starPartition` implementation variant (Seq.inject) | Prose shows an implementation using V', TH, Seq.inject, filter. Code uses HashMap-based inject instead. |

### Code with No Prose Counterpart

| # | Function | Notes |
|---|----------|-------|
| 1 | `build_quotient_graph` | Helper for contraction Line 7. Implicit in prose. |
| 2 | `build_quotient_graph_parallel` | Parallel version of same helper. |
| 3 | `route_edges_parallel` | Fork-join edge routing. Implementation detail. |
| 4 | `contract_to_vertices` / `contract_to_vertices_mt` | Convenience wrappers with identity base/expand. |

## Phase 8: Table of Contents Review

### TOC Presence

| # | File | TOC Present? | Section Headers? | Notes |
|---|------|:------------:|:----------------:|-------|
| 1 | StarPartitionStEph.rs | No | No | Trait inside `verus!`, impl outside — no TOC yet |
| 2 | StarPartitionMtEph.rs | No | No | Trait inside `verus!`, impl outside — no TOC yet |
| 3 | StarContractionStEph.rs | No | No | Trait inside `verus!`, impl outside — no TOC yet |
| 4 | StarContractionMtEph.rs | No | No | Trait inside `verus!`, impl outside — no TOC yet |

All four files now have `verus!` blocks containing trait definitions. The TOC standard applies but is not yet implemented. TOCs should be added when more code moves inside `verus!`.

### In/Out Table

| # | File | Clone | PartialEq/Eq | Default | Drop | Iterator | Debug | Display | Macro | Other |
|---|------|:-----:|:------------:|:-------:|:----:|:--------:|:-----:|:-------:|:-----:|-------|
| 1 | StarPartitionStEph.rs | - | - | - | - | - | - | - | - | trait defs ✅ in |
| 2 | StarPartitionMtEph.rs | - | - | - | - | - | - | - | - | trait defs ✅ in |
| 3 | StarContractionStEph.rs | - | - | - | - | - | - | - | - | trait defs ✅ in |
| 4 | StarContractionMtEph.rs | - | - | - | - | - | - | - | - | trait defs ✅ in |

No derive impls in any file. Trait definitions are correctly inside `verus!` blocks. Implementation functions are outside `verus!` behind `#[cfg(not(verus_keep_ghost))]` — this is the expected pattern for partially verusified modules where the impl bodies use features Verus cannot yet handle (RNG, ParaPair!, HashMap, etc.).

## Proof Holes Summary

```
✓ StarContractionMtEph.rs
✓ StarContractionStEph.rs
✓ StarPartitionMtEph.rs
✓ StarPartitionStEph.rs

Modules:  4 clean, 0 holed
Holes Found: 0
```

No proof holes. The trait definitions inside `verus!` contain no `assume`, `admit`, or `external_body`. The cfg-gated implementations are invisible to Verus.

## Spec Strength Summary

| Classification | Count |
|:-------------:|:-----:|
| strong | 0 |
| partial | 0 |
| weak | 0 |
| none | **9** |

All 9 functions have **no functional specification**. The trait method declarations inside `verus!` have no `requires`/`ensures` — they are type-checked but not functionally specified.

## Overall Assessment

### Status: Partially Verusified — Trait Definitions Inside verus!

Chapter 62 has been partially verusified: trait definitions have been moved inside `verus!` blocks and the chapter is no longer gated behind `#[cfg(not(verus_keep_ghost))]` in `lib.rs`. Verus now type-checks the trait method signatures. Implementation functions remain outside `verus!` behind `#[cfg(not(verus_keep_ghost))]`.

### Strengths

1. **Algorithmic correctness**: The sequential implementations (`StarPartitionStEph`, `StarContractionStEph`) faithfully follow the prose algorithms.
2. **Higher-order structure**: `star_contract` correctly implements the higher-order pattern from Algorithm 62.5 (base/expand callbacks).
3. **Partial parallelism**: `route_edges_parallel` and `build_quotient_graph_parallel` achieve genuine parallelism via `ParaPair!`.
4. **Verusified trait signatures**: Trait definitions are inside `verus!` and type-checked by Verus, providing a foundation for adding functional specs.

### Weaknesses

| # | Severity | Issue |
|---|:--------:|-------|
| 1 | **High** | All 9 functions have no spec (no `requires`/`ensures`) — trait signatures are type-checked but not functionally specified |
| 2 | **High** | Implementation bodies remain outside `verus!` — no formal verification of algorithm logic |
| 3 | **High** | No runtime tests — 0/4 modules have test files |
| 4 | **High** | Parallelism gap — `parallel_star_partition` is entirely sequential despite being in an Mt module; `star_contract_mt` cannot achieve its APAS span of O(lg² n) |
| 5 | **Low** | No TOC headers — none of the 4 files follow the table-of-contents standard |
| 6 | **Low** | Return type mismatch — Trait signatures for `sequential_star_partition` and `parallel_star_partition` declare `-> SetStEph<SetStEph<V>>` but the implementations return `-> (SetStEph<V>, HashMap<V, V>)`. The trait functions are never called through the trait. |

### What Verusification Achieved

1. **Trait definitions inside `verus!`** — Verus type-checks method signatures, ensuring type consistency.
2. **Chapter visible to Verus** — no longer gated behind `#[cfg(not(verus_keep_ghost))]` in `lib.rs`.
3. **Foundation for specs** — trait methods can now receive `requires`/`ensures` clauses incrementally.

### What Remains

| # | Priority | Action |
|---|:--------:|--------|
| 1 | High | Add runtime tests for all 4 modules. |
| 2 | High | Add functional specs (`requires`/`ensures`) to trait method declarations. |
| 3 | High | Implement parallel phases in `parallel_star_partition` (coin flip, filter, inject, center extraction). |
| 4 | Medium | Move implementation bodies inside `verus!` where feasible (sequential functions that don't use RNG or ParaPair!). |
| 5 | Low | Add TOC headers to all files. |
| 6 | Low | Fix trait/impl return type mismatch. |
